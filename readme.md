# MotionAlert: Serverless Computing For IoT Project

## Introduction

The idea is to simulate an environment where an IoT sensor tracks movements within a room. The sensor sends a request for motion detection and, if present, asks you to choose which operation to perform (Do nothing or report intrusion). The report can be notified to a trusted person or to the police, at the user's choice after entering the password. All password and trusted contacts management operations can be performed directly from the bot. When the user reports the intrusion, the bot triggers the alarm. The user has the ability to activate and deactivate the alarm with a specific command. The technologies used are Nuclio, RabbitMQ, Docker, Node.js, Telegram, and SQL for the database.

### Nuclio
Nuclio is an high-performance "serverless" framework focused on data, I/O, and compute intensive workloads. It is used to deploy functions that are triggered by data sent to an MQTT topic, these data are processed and then used to perform certain actions, such as sending them to a specific MQTT queue.

### RabbitMQ
RabbitMQ is a messaging broker - an intermediary for messaging. It is used to receive data generated by MQTT clients or Nuclio functions which will then be consumed by other clients.

### Telegram
Telegram is a messaging app that has 400 million active users, allows you to create and publish your own bot. Within this project, the bot is used as a client to manage and perform some actions on the air purifier based on the data received.

### Node.js
Node.js (Node) is an open-source development platform for executing JavaScript code server-side. In this project it is used to create the telegram bot and clients where the data published in the MQTT queues will be displayed.

### Docker
Docker is an open platform for developing, shipping, and running applications allowin to separate your applications from your infrastructure. Docker is used to run Nuclio and RabbitMQ.

----------------------------------------------------------------------------------------------------------------------------

**The libraries used in the project are:**
 - **Telegraf:** Telegraf is used for the creation of the bot and its commands.
 - **amqplib:** amqplib allows you to connect, send and consume messages from AMQP queues.
 - **mqtt:** amqplib allows you to connect, send and consume messages from MQTT queues.
 - **mssql:** mssql is a Microsoft SQL Server client for Node.js.
 - **dotenv**: dotenv is a zero-dependency module that loads environment variables from a .env file 

----------------------------------------------------------------------------------------------------------------------------

## Architecture

To simulate the sensor data of the motion detector, we can use two tools:
- Use an MQTT client from your smartphone.
- Use the function **sendrandommotion** present in the yaml_functions folder

The value sent by one of the two previous choices is an integer and indicate if the sensor has detected movement (1) or not (0). This value is published to the RabbitMQ topic <strong>"iot/sensors/motion"</strong>. 

At this point a Nuclio function is triggered: <strong>consume_motion</strong>. 

This function process and check its value. If the value is "1" it send the value to the RabbitMQ queue <strong>"iot/sensors/answare"</strong>. If the value is "0" the value is sent to RabbitMQ queue <strong>"iot/logs"</strong>. 

At this point in the Telegram bot, the message in the <strong>"iot/sensors/answare"</strong> is intercepted and the message is sent to the user. The user can choose to ***report the intrusion*** or ***not***. If the user choose to report, a message will send to the RabbitMQ queue <strong>"iot/sensors/alarm"</strong> in which it is indicated that the alarm must be activated. Furthermore, if the user chooses to activate / deactivate the alarm, also in this case it is notified on the RabbitMQ queue **iot/sensors/alarm**. Each cases the opeations performed by the user is sent to the RabbitMQ queue **iot/logs**.

![Architecture](https://github.com/GiuseppeGalante/MotionAlarm/blob/main/img/infrastracture.png)
----------------------------------------------------------------------------------------------------------------------------
## Installation
- **First of all we need to run RabbitMQ and Nuclio**:
  - Open two terminals, to run RabbitMQ using docker type:

    ```sh
    docker run -p 9000:15672  -p 1883:1883 -p 5672:5672  cyrilix/rabbitmq-mqtt
    ```
  - On the second terminal, to run Nuclio using docker type:

    ```sh
    docker run -p 8070:8070 -v /var/run/docker.sock:/var/run/docker.sock -v /tmp:/tmp nuclio/dashboard:stable-amd64
    ```
  
- **Update and deploy functions**:

  - Browse to [Nuclio Dashboard](http://localhost:8070) to open the homepage of Nuclio.
  - Create new project and call it **MotionAlarm**.
  - Select the **MotionAlarm** project.
  - Press '**Create function**', '**Import**' and upload the two functions that are in the **yaml_functions** folder.
  - In both cases, **change the already present IP with your IP**; also in the tab regarding the trigger.
     ```js
      connect("amqp://guest:guest@INSERT_YOUR_IP:5672")
     ```
  - Press **'Deploy'**.

- **Create personal Telegram Bot**:
   - Open Telegram and search for [BotFather](https://t.me/BotFather).
   - Press **start** and type **/newbot**.
   - Follow the instructions gived by BotFather and give it a name and an unique id.
   - Copy and paste the **Token** that BotFather gave you in the **BOT_TOKEN** in [env](src/.env) file;
   
 - **Create the database**:
   - Use the query contained in the [database](database) for creating the table and insert the initial data in your Microsoft SQL database.

- **Install all dependencies, start Telegram bot's server, Alarm_Status and Logger**:

  - Open .env file and insert your IP address instead of **'INSERT_YOUR_IP'** in the field **IP**.
  - Insert your MQTT IP address instead of **'INSERT_YOUR_IP'** in the field **IP_MQTT**.
  - Insert the SQL server name instead of **'INSERT_YOUR_SQL_SERVER'** in the field **SERVER**.
   - Insert the SQL database name instead of **'INSERT_YOUR_DATABASE_NAME'** in the field **DATABASE**.
   - Insert the SQL database username instead of **'INSERT_YOUR_DATABASE_USERNAME'** in the field **USER_DATA**.
   -  Insert the SQL database password instead of **'INSERT_YOUR_DATABASE_PASSWORD'** in the field **PASSWORD_DATABASE**.
  - Install requirements:
   ```sh
    npm install
   ```
    - Open three terminals, to run the bot.js using Node.js type:
  ```sh
    node bot.js
   ```
    - on the second, to run the client that tracks the status of the air purifier type:
  ```sh
    node alarm_status.js
   ```
     - on the last one, to run the logger client type:
    ```sh
     node logger.js
    ```
- **Now we can use the Telegram client**:
  - Open Telegram
  - Run bot using **/start**

After all this steps, you can use the **sendrandommotion** function on Nuclio or **MQTT client** from your smartphone. If the value is "1", you will be notified on the bot and asked to make a decision.
